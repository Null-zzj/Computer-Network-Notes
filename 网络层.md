# 网络层

## 网络层概述

- 网络层的主要任务是**实现网络互联**，进而**实现数据包在网络间之间的传输**
- 要实现网络层的任务，则需要解决一下主要问题
  - 网络层向运输层提供怎样的服务（**可靠传输**还是**不可靠传输**）
  - 网络层寻址问题
  - 路由选择问题
- 因特网（internet）是目前全世界用户数量最多的互联网，它使用**TCP/IP**协议栈
- 由于**TCP/IP**协议栈的网络层使用**网际协议IP**，它是整个协议栈的核心协议，因此在TCP/IP协议栈中网络层通常被称为**网际层**

## 网络层提供的两种服务

### 面向连接的虚电路服务

- **可靠通信由网络来保证**
- 必须建立**网络层的连接---虚电路VC**（Virtual Circuit）
- 通信双方**沿着已建立的虚电路发送分组**

### 无连接的数据报服务

- **可靠通信有主机来保证**
- **不需要建立网络层连接**
- **每个分组可走不同路径**
- 每个分组的**首部必须携带目的主机的完整地址**
- 这种通信方式所传送的**分组可能误码，丢失，重复和时序**

### 网络层的两个层面

在路由器之间传送的信息有一下两大类：

- 转发源主机和目的主机之间所传送的**数据**
- **传送路由信息** （是根据路由算法导出为转发分组而用的转发表）

因此，网络层可抽象为**数据层面**和**控制层面**

## 网际协议 IP

### IP地址

#### 概述

- **IPv4地址**就是给英特网上的**每一台主机（或路由器）的每一个接口**分配一个在全世界范围内是一个**唯一的32比特的标识符**
- IP地址由英特网名字和数字分配机构**ICANN**进行分配
- IPv4地址使用**点分10进制表示方法**以方便用户使用

#### 分类的IP地址

- A类地址

  ![A类地址](images.assets/A类地址.png)

  最小网络号0，保留不指派

  第一个可指派的网络号为1，网络地址为 1.0.0.0

  最大网络号为 127，作为本地回环测试，不指派

  范围 0 - 127， 可指派的网络数量 = 2^(8-1) - 2 = 126

- B类地址

  ![B类地址](images.assets/B类地址.png)

  最小网络号为128.0，其网络地址为128.0.0.0

  最大网络号也是最后一个可指派网络号为191.255， 其网络地址为191.255.0.0

  可分配范围 128 - 191， 可指派网络数量 = 2^(16-2)

- C类地址

  ![C类地址](images.assets/C类地址.png)
  最小网络号192.0.0，其网络地址为 192.0.0.0

  最大网络号也是最后一个可指派网络号为223.255.255，其网络地址为223.255.255.0

  可分配范围 192 - 223, 可指派的网络地址数量 = 2^(24 - 3 )

- D类地址

  多播地址，该地址前缀为1110

  可分配范围 224 - 239

- E类地址

  保留地址，该地址前缀为1111
  
  不可被分配， 范围 240 - 255

### RIP协议

#### 概述

- 路由信息协议RIP(Routing Information Protocol)是内部网关协议IGP中最先得到广泛使用的协议之一
- RIP要求自治系统AS内的每一个路由器都要维护从它自己到AS内其他每一个网络的距离记录。这是一组距离，称为“距离向量"
- RIP使用跳数(Hop Count)作为度量(Metric)来衡量到达目的网络的距离。
  - 路由器到直连网络的距离定义为1。
  - 路由器到非直连网络的距离定义为所经过的路由器数加1。
  - 允许一条路径最多只能包含15个路由器。“距离”等于16时相当于不可达。因此，RIP只适用于小型互联网

#### RIP协议的工作过程

- 路由器刚开始工作时，只知道自己到直连网络的距离为1。
- 每个路由器仅和相邻路由器周期性地交换并更新路由信息。
- 若干次交换和更新后，每个路由器都知道到达本AS内各网络的最短距离和下一跳地址，称为收敛。

#### RIP协议的路由条目的更新规则

- 发现了新的网络，添加
- 到达目的网络，相同下一跳，最新消息，更新
- 到达目的网络，不同下一跳，新路由优势，更新
- 到达目的网络，不同下一跳，新路由劣势，不更新
- 到达目的网络，不同下一跳，等价负载均衡

#### RIP协议存在“坏消息”传得慢的问题

- “坏消息传播得慢”又称为路由环路或距离无穷计数问题，这是距离向量算法的一个固有问题。可以采取多种措施减少出现该问题的概率或减小该问题带来的危害。
  - 限制最大路径距离为15(16表示不可达)
  - 当路由表发生变化时就立即发送更新报文（即“触发更新”)，而不仅是周期性发送
  - 让路由器记录收到某特定路由信息的接口，而不让同一路由信息再通过此接口向反方向传送(即“水平分割"

### OSPF协议

#### 概述

- 开放最短路径优先OSPF(Open Shortest Path First)，是为克服RIP的缺点在1989年开发出来的。
  - “开放”表明OSPF协议不是受某一家厂商控制，而是公开发表的。
  - “最短路径优先”是因为使用了Dijkstra提出的最短路径算法SPF。
- OSPF是基于链路状态的，而不像RIP那样是基于距离向量的。
- OSPF采用SPF(最短路径优先)算法计算路由，从算法上保证了不会产生路由环路。
- OSPF不限制网络规模，更新效率高，收敛速度快。
- 链路状态是指本路由器都和哪些路由器相邻，以及相应链路的“代价”(cost)。
  - “代价”用来表示费用、距离、时延、带宽，等等。这些都由网络管理人员来决定。
- 使用OSPF的每个路由器都会产生链路状态通告LSA


####  开放最短路径优先OSPF的基本工作原理

- OSPF相邻路由器之间通过交互问候(Hello)分组，建立和维护邻居关系。
  - Hello分组封装在IP数据报中，发往组播地址224.0.0.5;
  ![hello分组数据报](images.assets/hello分组.png)
  - 发送周期为10秒
  - 40秒未收到来自邻居路由器的hello分组，则认为该邻居路由器不可达
  ![1](images.assets/hello1.png)
  ![2](images.assets/hello2.png)

#### 链路状态通告

- 使用OSPF的每个路由器都会产生链路状态通告LSA(Link State Advertisement)。LSA中包含以下内容:
  - 直连网络的链路状态信息
  - 邻居路由器的链路状态信息
  ![LSA](images.assets/LSA.png)
- LSA被封装在链路状态更新分组LSU中，采用洪泛法发送。
![LSU](images.assets/LSU.png)
- 使用OSPF的每个路由器都有一个链路状态数据库LSDB，用于存储LSA.
- 通过各路由器洪泛发送封装有自己LSA的LSU分组，各路由器的LSDB最终将达到一致。
![LSDB](images.assets/LSDB.png)

- OSPF有以下五种分组类型
  - 类型1，问候(Hello)分组: 用来发现和维护邻居路由器的可达性。
  - 类型2，数据库描述(Database Description)分组: 向邻居路由器给出自己的链路状态数据库中的所有链路状态项目的摘要信息
  - 类型3，链路状态请求(Link State Request)分组: 向邻居路由器请求发送某些链路状态项目的详细信息。
  - 类型4，链路状态更新(Link State Update)分组: 路由器使用这种分组将其链路状态进行洪泛发送，即用洪泛法对全网更新链路状态。
  - 类型5，链路状态确认(Link State Acknowledgment)分组: 这是对链路状态更新分组的确认分组。

#### OSPF基本工作过程

![过程](./images.assets/OSPF基本过程.png)

#### OSPF在多点接入网络中路由器邻居关系的建立

- 链路状态确认(Link State Acknowledgment)分组
- 选举指定路由器DR(designated router)和备用的指定路由器BDR(backup designated router)
- 所有的非DR/BDR只与DR/BDR建立邻居关系
- 非DR/BDR之间通过DR/BDR交换信息

![DR/BDR](./images.assets/DRBDR.png)


### GBP协议

### 网际控制协议ICMP


### 专用虚拟网络VPN与网络地址转换NAT




